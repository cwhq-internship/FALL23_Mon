{% extends 'layout.html' %}
{% set title="Test" %}
{% block e %} active-bar {% endblock %}
{% block styles %}
    <link href='{{url_for("static", filename="stylesheets/test.css")}}' rel='stylesheet'/>
    <link href='{{url_for("static", filename="stylesheets/layout.css")}}' rel='stylesheet'/>
{% endblock %}

{% block content %}
<div class="outer">
<div class="inner">
  <div id="gameOver" style="display: none;">Game over! You're a&nbsp;<span id="typingMessage"></span>&nbsp;typer with&nbsp;<span id="WPM"></span>&nbsp;WPM!</div>
  <button id="retry" style="display: none;"><a href="testhard" id="aretry">Retry?</a></button>
  <div class="words text-center h1 current-word" id="currentWord">Loading...</div>
  <div class="words text-center text-muted next-word" id="nextWord">Loading...</div>
</div>

<div class="inputs">
  <div class="row">
    <div class="wordTyped"> 
      <div id="typedWord"></div>
    </div>    
    <div id="underline">
      <div id="typeHere">Click here and start typing!</div>
    </div>
    <input class="type" type="text" id="inputField" placeholder="Type here" autofocus>
  </div>
  <div class="rowboard">
    <div class="scoreboard">
      <div class="scorelabel"><p>Score:</p> <span id="score" class="h3 text-center">0</span></div>
    </div>
    <div class="timer">
      <div class="scorelabel"><p>Time Left:</p><span id="timer">30</span></div>
    </div>
    <div class="timer">
      <div class="scorelabel"><p>Skips left:</p><span id="skipCount">3</span></div>
    </div>
  </div>
</div>
</div>

<!-- hiding this dude at the bottom bec its not pretty tbh -->
<div class="keyboard">
  <div class="row">
    <div class="key" data-key="Q">Q</div><div class="key" data-key="W">W</div><div class="key" data-key="E">E</div>
    <div class="key" data-key="R">R</div><div class="key" data-key="T">T</div><div class="key" data-key="Y">Y</div>
    <div class="key" data-key="U">U</div><div class="key" data-key="I">I</div><div class="key" data-key="O">O</div>
    <div class="key" data-key="P">P</div>
  </div>
  <div class="row">
    <div class="key" data-key="A">A</div><div class="key" data-key="S">S</div><div class="key" data-key="D">D</div>
    <div class="key" data-key="F">F</div><div class="key" data-key="G">G</div><div class="key" data-key="H">H</div>
    <div class="key" data-key="J">J</div><div class="key" data-key="K">K</div><div class="key" data-key="L">L</div>
  </div>
  <div class="row">
    <div class="key" data-key="Z">Z</div><div class="key" data-key="X">X</div><div class="key" data-key="C">C</div>
    <div class="key" data-key="V">V</div><div class="key" data-key="B">B</div><div class="key" data-key="N">N</div>
    <div class="key" data-key="M">M</div>
  </div>
</div>

<script>
// Constants and definitions 
const wordList = [
  "account", "balance", "capture", "diamond", "element", "fashion", "general", "holiday", "journal",
  "library", "mission", "network", "outside", "popular", "quality", "resolve", "station", "visible",
  "whisper", "society", "science", "channel", "comfort", "awesome", "happening", "language", "machine",
  "possible", "register", "resource", "solution", "stunning", "training", "victory", "wildfire", "zeppelin"];
const inputField = document.getElementById('inputField');
const inner = document.querySelector('.inner');
let previousWord = '';
let currentWord = getRandomWord();
let nextWord = getRandomWord();
let score = 0;
let timeLeft = 30;
let timer;
let skipCount = 3;
let WPM = score * 2;

// Defines newWord with a random word
function getRandomWord() {
  let newWord = wordList[Math.floor(Math.random() * wordList.length)];
  while (newWord === previousWord) {
    newWord = wordList[Math.floor(Math.random() * wordList.length)];
  }
  previousWord = newWord;
  return newWord;
}

// Takes newWord pushes it into currentWord and nextWord
function updateWords() {
  const currentWordElement = document.getElementById('currentWord');
  currentWordElement.textContent = currentWord;

  const nextWordElement = document.getElementById('nextWord');
  nextWordElement.textContent = nextWord;
}

// Good old fasioned timer, pulled it from a stack overflow, only triggers after first word is correctly inputted
function startTimer() {
  timer = setInterval(() => {
    if (timeLeft > 0) {
      document.getElementById('timer').textContent = timeLeft;
      timeLeft--;
    } else {
      clearInterval(timer);
      inputField.value = '';
      document.getElementById('timer').textContent = '0';
      document.getElementById('gameOver').style.display = 'flex';
      document.getElementById("WPM").textContent = score * 2;
      document.getElementById('typingMessage').style.display = 'block';
      document.getElementById('retry').style.display = 'block';
      document.getElementById('nextWord').style.display = 'none';
      document.getElementById('currentWord').style.display = 'none';
      inner.style.flexDirection = 'column';
      myInput.disabled = true;
    }
  }, 1000);
}
// Checking input, makes everything lowercase for consistency
function checkInput() {
  const inputField = document.getElementById('inputField');
  const typedWordElement = document.getElementById('typedWord');
  const currentWordElement = document.getElementById('currentWord');

  inputField.addEventListener('input', function(event) {
    const typedWord = event.target.value.trim().toLowerCase();
    const displayedWord = currentWordElement.textContent.trim().toLowerCase();
// This checks to see if the words are matching, and then changes the colors of the letter if wrong
    let comparedWord = '';
    for (let i = 0; i < displayedWord.length; i++) {
      if (typedWord[i] === displayedWord[i]) {
        comparedWord += typedWord[i];
      } else {
        comparedWord += `<span>${typedWord[i] || '_'}</span>`;
      }
    }
    typedWordElement.innerHTML = comparedWord;
// Checking if word matches, then it displays another, adds score, etc etc.
    if (typedWord === displayedWord) {
      if (!timer) {
        startTimer();
      }
      currentWord = nextWord;
      nextWord = getRandomWord();
      score++;
      document.getElementById('score').textContent = score;
      updateWords();
      inputField.value = '';
      typedWordElement.innerHTML = '';
      document.getElementById('gameOver').style.display = 'none';
      checkScore();
    }
  });
}

// This judges you based on your score ofc :)
function checkScore () {
  if (score > 35) {
    message = " fantastic ";
  } else if (score > 20) {
    message = " meh ";
  } else {
    message = " bad ";
  }
  document.getElementById("typingMessage").textContent = message;
}

// Hitting space, it switches current word with a new, random word. Doesn't affect next word at all.
// -1 from the skipCount
function skipWord() {
  if (skipCount > 0) {
    currentWord = getRandomWord();
    updateWords();
    skipCount--;
    inputField.value = '';
    document.getElementById("skipCount").textContent = skipCount;
  }
}

// Space = activate skipWord
document.addEventListener("keydown", function(event) {
  if (event.code === "Space") {
    skipWord();
  }});

// Esc = immediate gameOver
document.addEventListener('keydown', function(event) {
  if (event.code === 'Escape') {
    clearInterval(timer);
    document.getElementById('timer').textContent = '0';
    document.getElementById('gameOver').style.display = 'flex';
    document.getElementById('WPM').textContent = score * 2;
    document.getElementById('typingMessage').style.display = 'block';
    document.getElementById('retry').style.display = 'block';
    document.getElementById('nextWord').style.display = 'none';
    document.getElementById('currentWord').style.display = 'none';
    inner.style.flexDirection = 'column';
    myInput.disabled = true;
  }
});
    
// Keyboard script, so it all words and stuff
document.addEventListener('keydown', function(event) {
  const keyPressed = event.key.toUpperCase();
  const keyElement = document.querySelector(`[data-key="${keyPressed}"]`);
  if (keyElement) {
    keyElement.classList.add('lit');
   }
});

document.addEventListener('keyup', function(event) {
  const keyPressed = event.key.toUpperCase();
  const keyElement = document.querySelector(`[data-key="${keyPressed}"]`);
    if (keyElement) {
    keyElement.classList.remove('lit');
  }
});
// end of Keyboard script

// Makes the "Click here and type a word to start!" disappear when clicked
function hideElementOnClick(inputId, elementId) {
  const inputField = document.getElementById(inputId);
  const elementToHide = document.getElementById(elementId);

  inputField.addEventListener('click', function() {
    elementToHide.style.display = 'none';
  });
}
hideElementOnClick('inputField', 'typeHere');

// this just runs the stuff beforehand so everything functions
updateWords();
checkInput();
checkScore();
</script>
{% endblock %}